<!DOCTYPE html>
<html lang="ru">
<head>
    <meta name="fc:miniapp" content='{"version":"1","imageUrl":"https://arcade-game-topaz.vercel.app/image.png","button":{"title":"Play Game üöÄ","action":{"type":"launch_frame","name":"Arcade Game Base","url":"https://arcade-game-topaz.vercel.app","splashImageUrl":"https://arcade-game-topaz.vercel.app/image.png","splashBackgroundColor":"#000000"}}}' />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Arcade Game Base</title>

    <meta property="og:title" content="Arcade Game Base">
    <meta property="og:description" content="Deliver transaction in 1 second!">
    <meta property="og:image" content="https://arcade-game-topaz.vercel.app/image.png">
    
    <meta name="fc:frame:image" content="https://arcade-game-topaz.vercel.app/image.png">
    <meta name="fc:frame:button:1" content="Play Game üöÄ">
    <meta name="fc:frame:button:1:action" content="link">
    <meta name="fc:frame:button:1:target" content="https://arcade-game-topaz.vercel.app">

    <script src="https://cdn.jsdelivr.net/npm/@farcaster/miniapp-sdk/dist/index.min.js"></script>

    <script>
        window.addEventListener('load', () => {
            console.log("The page is loaded, let's look for the SDK...");

            // –í –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —Å–∫–∞–∑–∞–Ω–æ: –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç 'miniapp'
            if (window.miniapp && window.miniapp.sdk) {
                console.log("‚úÖ SDK found (window.miniapp.sdk)");
                
                try {
                    // –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ –≤–µ—Ä–Ω—ã–π –≤—ã–∑–æ–≤ –¥–ª—è Mini Apps
                    window.miniapp.sdk.actions.ready();
                    console.log("üöÄ The ready() command was sent successfully!");
                } catch (e) {
                    console.error("‚ùå Error calling ready:", e);
                }
            } else {
                console.error("‚ùå Critical error: Object 'miniapp' not found. SDK script failed to load");
            }
        });
    </script>

    <style>
        /* === –í–ê–®–ò –°–¢–ò–õ–ò (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô) === */
        :root { --safe-top: env(safe-area-inset-top, 0px); --safe-right: env(safe-area-inset-right, 0px); --safe-bottom: env(safe-area-inset-bottom, 0px); --safe-left: env(safe-area-inset-left, 0px); }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #000; display: flex; justify-content: center; align-items: center; height: 100svh; overflow: hidden; }
        #gameContainer { position: relative; width: min(100vw, 800px); aspect-ratio: 4 / 3; height: auto; max-height: 100svh; background: linear-gradient(180deg, #001a4d 0%, #003380 100%); border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); overflow: hidden; margin: auto; }
        @media (max-width: 820px) { #gameContainer { width: 100vw; height: 100svh; max-height: 100svh; aspect-ratio: auto; border-radius: 0; } }
        #gameCanvas { display: block; width: 100%; height: 100%; }
        #startScreen, #gameOverScreen, #shopScreen, #pauseScreen, #faqScreen, #leaderboardScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(0, 26, 77, 0.98) 0%, rgba(0, 51, 128, 0.98) 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; z-index: 100; overflow-y: auto; padding: calc(20px + var(--safe-top)) calc(20px + var(--safe-right)) calc(20px + var(--safe-bottom)) calc(20px + var(--safe-left)); }
        .hidden { display: none !important; }
        #startScreen::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 20% 50%, rgba(0, 82, 255, 0.3) 0%, transparent 50%), radial-gradient(circle at 80% 80%, rgba(0, 212, 255, 0.3) 0%, transparent 50%), radial-gradient(circle at 50% 20%, rgba(0, 150, 255, 0.2) 0%, transparent 50%); animation: bgPulse 4s ease-in-out infinite; z-index: -1; }
        @keyframes bgPulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        .top-ui { position: absolute; top: calc(12px + var(--safe-top)); left: calc(12px + var(--safe-left)); right: calc(12px + var(--safe-right)); display: flex; justify-content: space-between; color: white; font-size: clamp(12px, 2.2vw, 16px); z-index: 10; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8); }
        .top-ui-left, .top-ui-right { display: flex; gap: clamp(8px, 2vw, 20px); }
        .ui-item { display: flex; align-items: center; gap: 6px; background: rgba(0, 0, 0, 0.5); padding: clamp(6px, 1.6vw, 10px) clamp(8px, 2vw, 12px); border-radius: 8px; border: 1px solid rgba(0, 212, 255, 0.3); }
        #progressBar { position: absolute; top: calc(62px + var(--safe-top)); left: calc(14px + var(--safe-left)); right: calc(14px + var(--safe-right)); height: clamp(22px, 4.2vw, 35px); background: rgba(0, 0, 0, 0.7); border-radius: 17px; overflow: hidden; z-index: 10; border: 2px solid rgba(0, 212, 255, 0.4); }
        #progressFill { height: 100%; background: linear-gradient(90deg, #0052FF, #00D4FF); width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: clamp(11px, 2.4vw, 14px); box-shadow: 0 0 20px rgba(0, 212, 255, 0.6); }
        #speedometer { position: absolute; top: calc(98px + var(--safe-top)); left: 0; width: 100%; display: flex; justify-content: center; gap: clamp(8px, 2vw, 20px); padding: 4px 8px; background: transparent; color: #00D4FF; font-size: clamp(11px, 2.2vw, 14px); z-index: 10; text-shadow: 0 0 5px rgba(0, 0, 0, 0.8); }
        #speedometer > div { background: rgba(0, 0, 0, 0.6); padding: 4px 10px; border-radius: 15px; border: 1px solid rgba(0, 212, 255, 0.3); white-space: nowrap; }
        #mobileControls { position: absolute; bottom: calc(16px + var(--safe-bottom)); left: 0; width: 100%; display: none; justify-content: space-between; padding: 0 calc(18px + var(--safe-left)) 0 calc(18px + var(--safe-right)); z-index: 50; pointer-events: none; }
        .mobile-btn { width: clamp(58px, 16vw, 84px); height: clamp(58px, 16vw, 84px); font-size: clamp(22px, 6vw, 32px); border-radius: 50%; background: rgba(0, 82, 255, 0.4); border: 2px solid #00D4FF; color: white; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 0 20px rgba(0, 212, 255, 0.4); user-select: none; -webkit-tap-highlight-color: transparent; pointer-events: auto; }
        .mobile-btn:active { background: rgba(0, 82, 255, 0.8); transform: scale(0.95); }
        .mobile-btn-boost { background: rgba(255, 215, 0, 0.3); border-color: #FFD700; }
        .main-menu { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; width: 100%; max-width: 550px; padding: 25px 20px; background: rgba(0, 10, 40, 0.6); border-radius: 25px; box-shadow: 0 0 40px rgba(0, 212, 255, 0.4), 0 0 80px rgba(0, 82, 255, 0.3), inset 0 0 60px rgba(0, 212, 255, 0.1); border: 2px solid rgba(0, 212, 255, 0.5); position: relative; }
        .main-menu::before { content: ''; position: absolute; top: -4px; left: -4px; right: -4px; bottom: -4px; background: linear-gradient(45deg, #0052FF, #00D4FF, #0052FF, #00D4FF); background-size: 400% 400%; border-radius: 27px; z-index: -1; animation: neonGlow 3s ease infinite; filter: blur(8px); }
        @keyframes neonGlow { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
        .menu-header { display: flex; flex-direction: column; align-items: center; gap: 6px; margin-bottom: 3px; }
        .menu-title-wrapper { display: flex; align-items: center; gap: 12px; }
        .menu-logo { font-size: 42px; animation: logoFloat 3s ease-in-out infinite; filter: drop-shadow(0 0 20px rgba(0, 212, 255, 1)) drop-shadow(0 0 40px rgba(0, 82, 255, 0.8)); }
        @keyframes logoFloat { 0%, 100% { transform: translateY(0px) scale(1); } 50% { transform: translateY(-8px) scale(1.05); } }
        .menu-title { font-size: 36px; font-weight: bold; background: linear-gradient(135deg, #0052FF, #00D4FF, #0052FF); background-size: 200% 200%; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: gradientShift 3s ease infinite; text-shadow: 0 0 40px rgba(0, 212, 255, 0.8); letter-spacing: 2px; filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.6)); }
        @keyframes gradientShift { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
        .menu-subtitle { font-size: 16px; color: #00D4FF; margin-bottom: 6px; opacity: 0.9; letter-spacing: 3px; text-transform: uppercase; text-shadow: 0 0 10px rgba(0, 212, 255, 0.8), 0 0 20px rgba(0, 212, 255, 0.6), 0 0 30px rgba(0, 212, 255, 0.4); animation: subtitlePulse 2s ease-in-out infinite; }
        @keyframes subtitlePulse { 0%, 100% { opacity: 0.8; } 50% { opacity: 1; } }
        .menu-goal { background: linear-gradient(135deg, rgba(0, 82, 255, 0.4), rgba(0, 212, 255, 0.3)); border: 2px solid #00D4FF; border-radius: 12px; padding: 12px 15px; margin: 8px 0; width: 100%; text-align: center; font-size: 14px; box-shadow: 0 0 20px rgba(0, 212, 255, 0.5), 0 0 40px rgba(0, 82, 255, 0.3), inset 0 0 20px rgba(0, 212, 255, 0.1); animation: pulseGlow 2s ease-in-out infinite; }
        @keyframes pulseGlow { 0%, 100% { box-shadow: 0 0 20px rgba(0, 212, 255, 0.5), 0 0 40px rgba(0, 82, 255, 0.3), inset 0 0 20px rgba(0, 212, 255, 0.1); } 50% { box-shadow: 0 0 30px rgba(0, 212, 255, 0.8), 0 0 60px rgba(0, 82, 255, 0.5), inset 0 0 30px rgba(0, 212, 255, 0.2); } }
        .menu-goal strong { color: #FFD700; font-size: 15px; text-shadow: 0 0 10px rgba(255, 215, 0, 0.8); }
        .menu-controls { margin: 8px 0; width: 100%; padding: 12px; background: rgba(0, 82, 255, 0.2); border-radius: 10px; border: 1px solid rgba(0, 212, 255, 0.4); box-shadow: 0 0 15px rgba(0, 212, 255, 0.2), inset 0 0 15px rgba(0, 212, 255, 0.1); }
        .menu-controls > div:first-child { font-weight: bold; margin-bottom: 8px; color: #00D4FF; font-size: 14px; text-shadow: 0 0 10px rgba(0, 212, 255, 0.8); }
        .controls-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 6px 0; }
        .control-item { font-size: 13px; display: flex; align-items: center; justify-content: flex-start; gap: 6px; padding: 4px 6px; }
        .control-icon { background: linear-gradient(135deg, #0052FF, #0080FF); border: 1px solid #00D4FF; border-radius: 5px; padding: 3px 6px; font-size: 11px; color: white; font-weight: bold; min-width: 40px; text-align: center; box-shadow: 0 0 10px rgba(0, 212, 255, 0.5), 0 2px 8px rgba(0, 82, 255, 0.4); }
        .bottom-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; width: 100%; }
        .bottom-button { padding: 11px 16px; font-size: 14px; font-weight: bold; border-radius: 10px; background: linear-gradient(135deg, #0052FF, #0080FF); color: white; border: 2px solid rgba(0, 212, 255, 0.5); cursor: pointer; transition: all 0.3s; box-shadow: 0 0 20px rgba(0, 212, 255, 0.4), 0 5px 15px rgba(0, 82, 255, 0.4), inset 0 0 10px rgba(0, 212, 255, 0.2); display: flex; align-items: center; justify-content: center; gap: 6px; position: relative; overflow: hidden; }
        .bottom-button::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent); transition: left 0.5s; }
        .bottom-button:hover::before { left: 100%; }
        .bottom-button:hover { transform: translateY(-3px); box-shadow: 0 0 30px rgba(0, 212, 255, 0.8), 0 8px 25px rgba(0, 130, 255, 0.6), inset 0 0 20px rgba(0, 212, 255, 0.3); border-color: rgba(0, 212, 255, 0.8); }
        .bottom-button:active { transform: translateY(-1px); }
        h2 { font-size: 36px; margin-bottom: 20px; color: #00D4FF; text-shadow: 0 0 20px rgba(0, 212, 255, 0.8); text-align: center; }
        p { font-size: 16px; margin: 8px 0; text-align: center; max-width: 600px; }
        button { background: linear-gradient(135deg, #0052FF, #0080FF); color: white; border: none; padding: 12px 30px; font-size: 18px; border-radius: 10px; cursor: pointer; margin: 5px; transition: all 0.3s; box-shadow: 0 5px 15px rgba(0, 82, 255, 0.4); font-weight: bold; }
        button:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 82, 255, 0.6); }
        button:active { transform: translateY(0); }
        .info-box { background: rgba(0, 82, 255, 0.2); border: 2px solid #0052FF; border-radius: 10px; padding: 15px; margin: 10px; max-width: 500px; width: 90%; }
        .upgrade-item { background: rgba(0, 212, 255, 0.1); border: 1px solid #00D4FF; border-radius: 8px; padding: 10px; margin: 8px; display: flex; justify-content: space-between; align-items: center; min-width: 400px; }
        @media (max-width: 600px) { .upgrade-item { min-width: 300px; flex-direction: column; gap: 10px; text-align: center; } }
        .button-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 10px; }
        .faq-item { background: rgba(0, 82, 255, 0.2); border: 1px solid #0052FF; border-radius: 8px; padding: 15px; margin: 8px; width: 100%; max-width: 600px; }
        .faq-item h3 { color: #00D4FF; margin-bottom: 8px; }
        .leaderboard-item { background: rgba(0, 82, 255, 0.2); border: 1px solid #0052FF; border-radius: 8px; padding: 12px; margin: 5px; width: 100%; max-width: 400px; display: flex; justify-content: space-between; align-items: center; }
        .leaderboard-rank { font-weight: bold; color: #00D4FF; min-width: 40px; font-size: 18px; }
        .leaderboard-name { flex-grow: 1; text-align: left; padding: 0 15px; }
        .leaderboard-score { font-weight: bold; color: #FFD700; font-size: 18px; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        
        <div class="top-ui">
            <div class="top-ui-left">
                <div class="ui-item">
                    <span>üí∞</span>
                    <span id="coins">0</span>
                </div>
                <div class="ui-item">
                    <span>‚ö°</span>
                    <span id="boosts">0</span>
                </div>
            </div>
            <div class="top-ui-right">
                <div class="ui-item">
                    <span>üìä</span>
                    <span id="score">0</span>
                </div>
                <div class="ui-item">
                    <span>üèÜ</span>
                    <span id="highScore">0</span>
                </div>
            </div>
        </div>

        <div id="progressBar">
            <div id="progressFill">0%</div>
        </div>

        <div id="speedometer">
            <div>üöÄ Spd: <span id="speed">0</span></div>
            <div>‚è±Ô∏è Tm: <span id="time">0.00</span>s</div>
            <div>üìç Dist: <span id="distanceDisplay">0</span>m</div>
        </div>

        <div id="mobileControls">
            <div class="mobile-btn mobile-btn-boost" id="btnBoost" title="–£—Å–∫–æ—Ä–µ–Ω–∏–µ">‚ö°</div>
            <div class="mobile-btn mobile-btn-jump" id="btnJump" title="–ü—Ä—ã–∂–æ–∫">‚¨ÜÔ∏è</div>
        </div>

        <div id="startScreen">
            <div class="main-menu">
                <div class="menu-header">
                    <div class="menu-title-wrapper">
                        <div class="menu-logo">üîµ</div>
                        <div class="menu-title">ARCADE GAME BASE</div>
                    </div>
                </div>
                <div class="menu-subtitle">Base Network</div>
                
                <div class="menu-goal">
                    <strong>üéØ Goal:</strong> Deliver transaction to block in <strong>1 second!</strong>
                </div>
                
                <div class="menu-controls">
                    <div>‚å®Ô∏è Controls:</div>
                    <div class="controls-row">
                        <div class="control-item">
                            <span class="control-icon">‚Üë / W</span>
                            <span>Jump</span>
                        </div>
                        <div class="control-item">
                            <span class="control-icon">‚Üì / S</span>
                            <span>Slide</span>
                        </div>
                    </div>
                    <div class="controls-row">
                        <div class="control-item">
                            <span class="control-icon">SPACE</span>
                            <span>Sub-Second</span>
                        </div>
                        <div class="control-item">
                            <span class="control-icon">ESC / P</span>
                            <span>Pause</span>
                        </div>
                    </div>
                </div>
                
                <div class="bottom-buttons">
                    <button class="bottom-button" onclick="startGame()">
                        üöÄ Start
                    </button>
                    <button class="bottom-button" onclick="showShop()">
                        üõí Shop
                    </button>
                    <button class="bottom-button" onclick="showFAQ()">
                        ‚ùì FAQ
                    </button>
                    <button class="bottom-button" onclick="showLeaderboard()">
                        üèÜ Leaderboard
                    </button>
                </div>
            </div>
        </div>

        <div id="pauseScreen" class="hidden">
            <h2>‚è∏Ô∏è PAUSED</h2>
            <div class="info-box">
                <p>üìä Current Score: <span id="pauseScore">0</span></p>
                <p>üìç Distance: <span id="pauseDistance">0</span>m / 25000m</p>
            </div>
            <div class="button-group">
                <button onclick="togglePause()">‚ñ∂Ô∏è Continue</button>
                <button onclick="restartFromPause()">üîÑ Restart</button>
                <button onclick="exitToMenu()">üè† Exit to Menu</button>
            </div>
        </div>

        <div id="gameOverScreen" class="hidden">
            <h2>üéâ Transaction Delivered!</h2>
            <div class="info-box">
                <p>‚úÖ Transaction successfully recorded on Base blockchain!</p>
                <p>üìä Your Score: <span id="finalScore">0</span></p>
                <p>‚è±Ô∏è Time: <span id="finalTime">0</span>s</p>
                <p>üìç Distance: <span id="finalDistance">0</span>m</p>
                <p>üí∞ Sub-Cents Collected: <span id="finalCoins">0</span></p>
                <p>üèÜ Best Score: <span id="finalHighScore">0</span></p>
            </div>
            <div class="button-group">
                <button onclick="restartGame()">üîÑ New Transaction</button>
                <button onclick="showShop()">üõí Upgrades Shop</button>
                <button onclick="backToMenu()">üè† Main Menu</button>
            </div>
        </div>

        <div id="shopScreen" class="hidden">
            <h2>üõí Upgrades Shop</h2>
            <p style="font-size: 20px; color: #FFD700;">üí∞ Your Sub-Cents: <span id="shopCoins">0</span></p>
            <div id="upgrades">
                <div class="upgrade-item">
                    <div>
                        <strong>üöÄ Base Speed</strong><br>
                        <small>Level: <span id="speedLevel">1</span></small>
                    </div>
                    <button onclick="buyUpgrade('speed')">Buy (100 üí∞)</button>
                </div>
                <div class="upgrade-item">
                    <div>
                        <strong>‚ö° Sub-Second Duration</strong><br>
                        <small>Level: <span id="boostLevel">1</span></small>
                    </div>
                    <button onclick="buyUpgrade('boost')">Buy (150 üí∞)</button>
                </div>
                <div class="upgrade-item">
                    <div>
                        <strong>üí∞ Sub-Cents Multiplier</strong><br>
                        <small>Level: <span id="coinLevel">1</span></small>
                    </div>
                    <button onclick="buyUpgrade('coin')">Buy (200 üí∞)</button>
                </div>
            </div>
            <button onclick="closeShop()">‚¨ÖÔ∏è Back</button>
        </div>
        
        <div id="faqScreen" class="hidden">
            <h2>‚ùì FAQ</h2>
            <p>List of game items and their meaning:</p>
            
            <div class="faq-item">
                <h3>üí∞ Sub-Cents (¬¢)</h3>
                <p>Main game currency. Used to purchase upgrades in the shop.</p>
            </div>
            
            <div class="faq-item">
                <h3>‚ö° Sub-Seconds</h3>
                <p>Allow you to temporarily increase character speed when pressing SPACE.</p>
            </div>
            
            <div class="faq-item">
                <h3>üî¥ "GAS" Obstacle</h3>
                <p>Red obstacles that slow down the character on collision.</p>
            </div>
            
            <div class="faq-item">
                <h3>üü† "SLOW" Obstacle</h3>
                <p>Orange obstacles that reduce movement speed on collision.</p>
            </div>
            
            <div class="faq-item">
                <h3>üíé Crystal</h3>
                <p>Rare item that gives a large amount of Sub-Cents.</p>
            </div>
            
            <div class="faq-item">
                <h3>üü¢ BasePay</h3>
                <p>Special item that gives Sub-Cents, Sub-Seconds and points.</p>
            </div>
            
            <button onclick="closeFAQ()">‚¨ÖÔ∏è Back</button>
        </div>
        
        <div id="leaderboardScreen" class="hidden">
            <h2>üèÜ Leaderboard</h2>
            <p>Top players by results:</p>
            <div id="leaderboardList"></div>
            <button onclick="closeLeaderboard()">‚¨ÖÔ∏è Back</button>
        </div>
    </div>

    <audio id="bgMusic" loop>
        <source src="https://anthonyrix.github.io/audio/chain-runner.mp3" type="audio/mpeg">
    </audio>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // --- RESPONSIVE LOGIC START ---
        const BASE_W = 800;
        const BASE_H = 600;

        // –ú–∞—Å—à—Ç–∞–± –∏–≥—Ä—ã (–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è 800x600)
        let scale = 1;
        let offsetX = 0;
        let offsetY = 0;

        function resizeCanvas() {
            const container = document.getElementById('gameContainer');
            const rect = container.getBoundingClientRect();

            const dpr = Math.min(window.devicePixelRatio || 1, 2); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º DPR –¥–æ 2 –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

            // –†–µ–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ö–æ–ª—Å—Ç–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            canvas.width  = Math.round(rect.width * dpr);
            canvas.height = Math.round(rect.height * dpr);

            // CSS —Ä–∞–∑–º–µ—Ä
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';

            // –í—ã—á–∏—Å–ª—è–µ–º –º–∞—Å—à—Ç–∞–± –¥–ª—è –≤–ø–∏—Å—ã–≤–∞–Ω–∏—è (letterbox)
            const sx = rect.width / BASE_W;
            const sy = rect.height / BASE_H;
            scale = Math.min(sx, sy);

            const viewW = BASE_W * scale;
            const viewH = BASE_H * scale;

            offsetX = (rect.width - viewW) / 2;
            offsetY = (rect.height - viewH) / 2;

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º —Å —É—á–µ—Ç–æ–º DPR (–Ω–æ –≤ —Ü–∏–∫–ª–µ –º—ã –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å —ç—Ç–æ —è–≤–Ω–æ –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä)
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }

        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('orientationchange', resizeCanvas);
        // –í—ã–∑–æ–≤–µ–º resizeCanvas –≤ –∫–æ–Ω—Ü–µ —Å–∫—Ä–∏–ø—Ç–∞
        // --- RESPONSIVE LOGIC END ---

        // Mobile Controls Visibility Logic
        const isTouch = matchMedia('(pointer: coarse)').matches;

        function setMobileControlsVisible(visible) {
            const el = document.getElementById('mobileControls');
            if (visible && isTouch) {
                el.style.display = 'flex';
            } else {
                el.style.display = 'none';
            }
        }

        // Sound effects (Web Audio API)
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        const sounds = {
            jump: () => playSound(300, 0.1, 'sine'),
            slide: () => playSound(150, 0.15, 'sawtooth'),
            coin: () => playSound(800, 0.1, 'sine', [800, 1000]),
            boost: () => playSound(400, 0.2, 'square', [400, 600, 800]),
            crystal: () => playSound(1200, 0.3, 'sine', [1200, 1400, 1600, 1800]),
            collision: () => playSound(100, 0.2, 'sawtooth'),
            basePay: () => playSound(600, 0.3, 'sine', [600, 700, 800, 900, 1000]),
            finish: () => playSound(800, 0.5, 'sine', [800, 1000, 1200, 1400, 1600])
        };

        function playSound(frequency, duration, type = 'sine', frequencies = null) {
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = type;
                oscillator.frequency.value = frequency;
                
                if (frequencies) {
                    const now = audioContext.currentTime;
                    frequencies.forEach((freq, i) => {
                        oscillator.frequency.setValueAtTime(freq, now + (i * duration / frequencies.length));
                    });
                }
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log('Sound error:', e);
            }
        }

        // Game variables
        let gameState = 'menu';
        let score = 0;
        let coins = 0;
        let boosts = 0;
        let distance = 0;
        let gameTime = 0;
        let highScore = localStorage.getItem('highScore') || 0;
        let isPaused = false;
        let isFinishing = false;
        let finishAnimationProgress = 0;
        
        // Finish constant (25000 meters = 1 second Base goal)
        const FINISH_DISTANCE = 25000;
        
        // Upgrades
        let upgrades = {
            speed: parseInt(localStorage.getItem('speedLevel')) || 1,
            boost: parseInt(localStorage.getItem('boostLevel')) || 1,
            coin: parseInt(localStorage.getItem('coinLevel')) || 1
        };

        // Player (transaction)
        const player = {
            x: 100,
            y: 400,
            width: 40,
            height: 40,
            velocityY: 0,
            jumping: false,
            sliding: false,
            boosting: false,
            boostTime: 0
        };

        // Finish block
        const finishBlock = {
            x: 0,
            y: 0,
            width: 100,
            height: 100,
            visible: false,
            rotation: 0
        };

        // Game objects
        let obstacles = [];
        let collectibles = [];
        let particles = [];
        let background = [];

        // Constants
        const GRAVITY = 0.6;
        const JUMP_FORCE = -12;
        const GROUND_Y = 400;
        let BASE_SPEED = 5 + (upgrades.speed - 1) * 0.5;
        let gameSpeed = BASE_SPEED;

        // Music
        const music = document.getElementById('bgMusic');

        // Initialize background
        function initBackground() {
            background = [];
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º BASE_W/BASE_H –¥–ª—è –ª–æ–≥–∏–∫–∏, —Ç–∞–∫ –∫–∞–∫ –º—ã –±—É–¥–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –∫–∞–Ω–≤–∞—Å
            for (let i = 0; i < 50; i++) {
                background.push({
                    x: Math.random() * BASE_W,
                    y: Math.random() * BASE_H,
                    size: Math.random() * 3 + 1,
                    speed: Math.random() * 2 + 1
                });
            }
        }

        // Draw background
        function drawBackground() {
            // –†–∏—Å—É–µ–º –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ 800x600
            const gradient = ctx.createLinearGradient(0, 0, 0, BASE_H);
            gradient.addColorStop(0, '#001a4d');
            gradient.addColorStop(1, '#003380');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, BASE_W, BASE_H);

            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            background.forEach(star => {
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                ctx.fill();
                
                if (!isPaused && !isFinishing) {
                    star.x -= star.speed * (gameSpeed / BASE_SPEED);
                    if (star.x < 0) {
                        star.x = BASE_W;
                        star.y = Math.random() * BASE_H;
                    }
                }
            });

            ctx.fillStyle = 'rgba(0, 82, 255, 0.3)';
            ctx.fillRect(0, GROUND_Y + 40, BASE_W, 10);
            
            ctx.strokeStyle = 'rgba(0, 212, 255, 0.5)';
            ctx.lineWidth = 2;
            for (let i = 0; i < BASE_W; i += 40) {
                const offset = (distance * 2) % 40;
                ctx.beginPath();
                ctx.moveTo(i - offset, GROUND_Y + 45);
                ctx.lineTo(i - offset + 20, GROUND_Y + 45);
                ctx.stroke();
            }
        }

        // Draw finish block
        function drawFinishBlock() {
            if (!finishBlock.visible) return;

            ctx.save();
            ctx.translate(finishBlock.x + finishBlock.width / 2, finishBlock.y + finishBlock.height / 2);
            ctx.rotate(finishBlock.rotation);

            ctx.shadowBlur = 30;
            ctx.shadowColor = '#00D4FF';

            const gradient = ctx.createLinearGradient(-50, -50, 50, 50);
            gradient.addColorStop(0, '#0052FF');
            gradient.addColorStop(0.5, '#00D4FF');
            gradient.addColorStop(1, '#0052FF');
            ctx.fillStyle = gradient;
            ctx.fillRect(-finishBlock.width / 2, -finishBlock.height / 2, finishBlock.width, finishBlock.height);

            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.fillRect(-finishBlock.width / 3, -finishBlock.height / 3, finishBlock.width * 2/3, finishBlock.height * 2/3);

            ctx.shadowBlur = 0;
            ctx.fillStyle = 'white';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('BLOCK', 0, 0);

            ctx.restore();
        }

        // Draw player
        function drawPlayer() {
            const size = player.sliding ? player.height * 0.6 : player.height;
            const y = player.sliding ? player.y + player.height * 0.4 : player.y;

            if (player.boosting) {
                ctx.shadowBlur = 20;
                ctx.shadowColor = '#00D4FF';
            }

            ctx.fillStyle = player.boosting ? '#00D4FF' : '#0052FF';
            ctx.beginPath();
            ctx.arc(player.x + player.width / 2, y + size / 2, size / 2, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(player.x + player.width / 2, y + size / 2, size / 3, 0, Math.PI * 2);
            ctx.fill();

            ctx.shadowBlur = 0;

            if (Math.random() < 0.3 && !isPaused && !isFinishing) {
                particles.push({
                    x: player.x,
                    y: y + size / 2,
                    size: Math.random() * 5 + 2,
                    life: 1,
                    color: player.boosting ? '#00D4FF' : '#0052FF'
                });
            }
        }

        function createObstacle() {
            const type = Math.random();
            if (type < 0.3) {
                obstacles.push({
                    x: BASE_W,
                    y: GROUND_Y,
                    width: 30,
                    height: 50,
                    type: 'gas'
                });
            } else if (type < 0.5) {
                obstacles.push({
                    x: BASE_W,
                    y: GROUND_Y + 20,
                    width: 60,
                    height: 20,
                    type: 'slow'
                });
            }
        }

        function createCollectible() {
            const type = Math.random();
            const y = Math.random() < 0.5 ? GROUND_Y - 80 : GROUND_Y - 40;
            
            if (type < 0.6) {
                collectibles.push({
                    x: BASE_W,
                    y: y,
                    size: 15,
                    type: 'coin',
                    value: 1 * upgrades.coin
                });
            } else if (type < 0.85) {
                collectibles.push({
                    x: BASE_W,
                    y: y,
                    size: 20,
                    type: 'boost'
                });
            } else if (type < 0.95) {
                collectibles.push({
                    x: BASE_W,
                    y: y,
                    size: 25,
                    type: 'crystal',
                    value: 10 * upgrades.coin
                });
            } else {
                collectibles.push({
                    x: BASE_W,
                    y: y,
                    size: 30,
                    type: 'basepay',
                    value: 20 * upgrades.coin
                });
            }
        }

        function drawObstacles() {
            obstacles.forEach((obs, index) => {
                if (obs.type === 'gas') {
                    ctx.fillStyle = '#FF4444';
                    ctx.fillRect(obs.x, obs.y, obs.width, obs.height);
                    ctx.fillStyle = 'white';
                    ctx.font = '12px Arial';
                    ctx.fillText('GAS', obs.x + 2, obs.y + 25);
                } else if (obs.type === 'slow') {
                    ctx.fillStyle = '#FFA500';
                    ctx.fillRect(obs.x, obs.y, obs.width, obs.height);
                }

                if (!isPaused && !isFinishing) {
                    obs.x -= gameSpeed;
                }

                if (obs.x + obs.width < 0) {
                    obstacles.splice(index, 1);
                }
            });
        }

        function drawCollectibles() {
            collectibles.forEach((item, index) => {
                if (item.type === 'coin') {
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.arc(item.x, item.y, item.size, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#FFA500';
                    ctx.font = 'bold 12px Arial';
                    ctx.fillText('¬¢', item.x - 4, item.y + 4);
                } else if (item.type === 'boost') {
                    ctx.fillStyle = '#00D4FF';
                    ctx.beginPath();
                    ctx.arc(item.x, item.y, item.size, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 16px Arial';
                    ctx.fillText('‚ö°', item.x - 6, item.y + 6);
                } else if (item.type === 'crystal') {
                    ctx.fillStyle = '#FF00FF';
                    ctx.save();
                    ctx.translate(item.x, item.y);
                    ctx.rotate(Date.now() / 200);
                    ctx.fillRect(-item.size/2, -item.size/2, item.size, item.size);
                    ctx.restore();
                } else if (item.type === 'basepay') {
                    ctx.fillStyle = '#00FF00';
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = '#00FF00';
                    ctx.beginPath();
                    ctx.arc(item.x, item.y, item.size, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 14px Arial';
                    ctx.fillText('BP', item.x - 10, item.y + 5);
                }

                if (!isPaused && !isFinishing) {
                    item.x -= gameSpeed;
                }

                if (!isPaused && !isFinishing) {
                    const playerCenterX = player.x + player.width / 2;
                    const playerCenterY = player.y + player.height / 2;
                    const dist = Math.sqrt(
                        Math.pow(playerCenterX - item.x, 2) + 
                        Math.pow(playerCenterY - item.y, 2)
                    );

                    if (dist < player.width / 2 + item.size) {
                        if (item.type === 'coin') {
                            coins += item.value;
                            score += 10 * item.value;
                            sounds.coin();
                        } else if (item.type === 'boost') {
                            boosts++;
                            sounds.boost();
                        } else if (item.type === 'crystal') {
                            coins += item.value;
                            score += 100;
                            sounds.crystal();
                        } else if (item.type === 'basepay') {
                            coins += item.value;
                            score += 200;
                            boosts += 2;
                            sounds.basePay();
                        }
                        collectibles.splice(index, 1);
                    }
                }

                if (item.x + item.size < 0) {
                    collectibles.splice(index, 1);
                }
            });
        }

        function drawParticles() {
            particles.forEach((p, index) => {
                ctx.fillStyle = p.color;
                ctx.globalAlpha = p.life;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;

                if (!isPaused && !isFinishing) {
                    p.x -= gameSpeed * 0.5;
                    p.life -= 0.02;
                    p.size *= 0.95;
                }

                if (p.life <= 0) {
                    particles.splice(index, 1);
                }
            });
        }

        function updatePlayer() {
            if (isPaused || isFinishing) return;

            if (!player.sliding) {
                player.velocityY += GRAVITY;
            }
            player.y += player.velocityY;

            if (player.y >= GROUND_Y) {
                player.y = GROUND_Y;
                player.velocityY = 0;
                player.jumping = false;
            }

            if (player.boosting) {
                player.boostTime--;
                gameSpeed = BASE_SPEED * 2;
                if (player.boostTime <= 0) {
                    player.boosting = false;
                    gameSpeed = BASE_SPEED;
                }
            }

            obstacles.forEach(obs => {
                if (checkCollision(player, obs)) {
                    if (!player.boosting) {
                        sounds.collision();
                        gameSpeed = Math.max(BASE_SPEED * 0.7, gameSpeed - 0.5);
                        setTimeout(() => {
                            if (!isPaused && !isFinishing) {
                                gameSpeed = BASE_SPEED;
                            }
                        }, 1000);
                    }
                }
            });
        }

        function checkCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }

        function updateFinishAnimation() {
            if (!isFinishing) return;

            finishAnimationProgress++;

            if (finishAnimationProgress < 60) {
                finishBlock.visible = true;
                finishBlock.x = BASE_W - 200 + (finishAnimationProgress * 2);
                finishBlock.y = GROUND_Y - 50;
                finishBlock.rotation += 0.1;
            }
            else if (finishAnimationProgress < 120) {
                player.x += 3;
                player.width *= 0.98;
                player.height *= 0.98;
                
                if (Math.random() < 0.5) {
                    particles.push({
                        x: player.x + player.width / 2,
                        y: player.y + player.height / 2,
                        size: Math.random() * 8 + 3,
                        life: 1,
                        color: '#00D4FF'
                    });
                }
            }
            else if (finishAnimationProgress === 120) {
                sounds.finish();
                setTimeout(() => {
                    endGame();
                }, 1000);
            }
        }

        // Logic for Actions
        function performJump() {
            if (gameState !== 'playing' || isPaused || isFinishing) return;
            if (!player.jumping && !player.sliding) {
                player.velocityY = JUMP_FORCE;
                player.jumping = true;
                sounds.jump();
            }
        }

        function performSlide(active) {
            if (gameState !== 'playing' || isPaused || isFinishing) return;
             if (active && !player.jumping) {
                player.sliding = true;
                sounds.slide();
            } else {
                player.sliding = false;
            }
        }

        function performBoost() {
            if (gameState !== 'playing' || isPaused || isFinishing) return;
            if (boosts > 0 && !player.boosting) {
                player.boosting = true;
                player.boostTime = 60 * upgrades.boost;
                boosts--;
                sounds.boost();
            }
        }

        // Keyboard Events
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' || e.key === 'p' || e.key === 'P') {
                togglePause();
                return;
            }

            if ((e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W')) {
                performJump();
            }

            if ((e.key === 'ArrowDown' || e.key === 's' || e.key === 'S')) {
                performSlide(true);
            }

            if (e.key === ' ') {
                e.preventDefault();
                performBoost();
            }
        });

        document.addEventListener('keyup', (e) => {
            if ((e.key === 'ArrowDown' || e.key === 's' || e.key === 'S')) {
                performSlide(false);
            }
        });

        // Touch Events for Mobile Buttons
        const btnJump = document.getElementById('btnJump');
        const btnBoost = document.getElementById('btnBoost');

        btnJump.addEventListener('touchstart', (e) => {
            e.preventDefault();
            performJump();
        });
        
        btnBoost.addEventListener('touchstart', (e) => {
            e.preventDefault();
            performBoost();
        });

        function togglePause() {
            if (gameState !== 'playing') return;

            isPaused = !isPaused;

            if (isPaused) {
                music.pause();
                document.getElementById('pauseScore').textContent = Math.floor(score);
                document.getElementById('pauseDistance').textContent = Math.floor(distance);
                document.getElementById('pauseScreen').classList.remove('hidden');
                setMobileControlsVisible(false); // Hide controls
            } else {
                music.play().catch(e => console.log('Music not loaded'));
                document.getElementById('pauseScreen').classList.add('hidden');
                setMobileControlsVisible(true); // Show controls
            }
        }

        function restartFromPause() {
            isPaused = false;
            document.getElementById('pauseScreen').classList.add('hidden');
            music.pause();
            startGame();
        }

        function exitToMenu() {
            isPaused = false;
            gameState = 'menu';
            music.pause();
            document.getElementById('pauseScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
            setMobileControlsVisible(false);
        }

        let lastObstacleTime = 0;
        let lastCollectibleTime = 0;

        function gameLoop() {
            if (gameState !== 'playing') return;

            // --- VIRTUAL CANVAS RENDER LOGIC ---
            // 1. –û—á–∏—â–∞–µ–º –≤–µ—Å—å —Ä–µ–∞–ª—å–Ω—ã–π —Ö–æ–ª—Å—Ç (–≤ –ø–∏–∫—Å–µ–ª—è—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞)
            ctx.setTransform(1, 0, 0, 1, 0, 0); 
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 2. –í–∫–ª—é—á–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç 800x600
            const dpr = Math.min(window.devicePixelRatio || 1, 2);
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // —É—á–∏—Ç—ã–≤–∞–µ–º –ø–ª–æ—Ç–Ω–æ—Å—Ç—å –ø–∏–∫—Å–µ–ª–µ–π
            ctx.translate(offsetX, offsetY);        // —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º
            ctx.scale(scale, scale);                // –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –ø–æ–¥ —ç–∫—Ä–∞–Ω
            // --- END RENDER LOGIC ---

            drawBackground();
            drawFinishBlock();
            drawPlayer();
            drawObstacles();
            drawCollectibles();
            drawParticles();
            
            if (!isPaused) {
                updatePlayer();
                updateFinishAnimation();
            }

            if (!isPaused && !isFinishing) {
                if (Date.now() - lastObstacleTime > 2000 + Math.random() * 1000) {
                    createObstacle();
                    lastObstacleTime = Date.now();
                }

                if (Date.now() - lastCollectibleTime > 800 + Math.random() * 400) {
                    createCollectible();
                    lastCollectibleTime = Date.now();
                }

                distance += gameSpeed;
                score += Math.floor(gameSpeed);
                gameTime += 1/60;

                if (distance >= FINISH_DISTANCE && !isFinishing) {
                    startFinishAnimation();
                }
            }

            const progress = Math.min((distance / FINISH_DISTANCE) * 100, 100);
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressFill').textContent = Math.floor(progress) + '% to 1 sec';

            document.getElementById('coins').textContent = coins;
            document.getElementById('boosts').textContent = boosts;
            document.getElementById('score').textContent = Math.floor(score);
            document.getElementById('speed').textContent = (gameSpeed * 10).toFixed(1);
            document.getElementById('time').textContent = gameTime.toFixed(2);
            document.getElementById('distanceDisplay').textContent = Math.floor(distance);

            requestAnimationFrame(gameLoop);
        }

        function startFinishAnimation() {
            isFinishing = true;
            finishAnimationProgress = 0;
            gameSpeed = 0;
        }

        function startGame() {
            gameState = 'playing';
            score = 0;
            distance = 0;
            gameTime = 0;
            isPaused = false;
            isFinishing = false;
            finishAnimationProgress = 0;
            BASE_SPEED = 5 + (upgrades.speed - 1) * 0.5;
            gameSpeed = BASE_SPEED;
            obstacles = [];
            collectibles = [];
            particles = [];
            
            player.x = 100;
            player.y = GROUND_Y;
            player.velocityY = 0;
            player.jumping = false;
            player.sliding = false;
            player.boosting = false;

            finishBlock.visible = false;
            finishBlock.x = 0;
            finishBlock.y = 0;
            finishBlock.rotation = 0;

            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('pauseScreen').classList.add('hidden');
            
            setMobileControlsVisible(true); // Show mobile controls logic
            
            music.currentTime = 0;
            music.play().catch(e => console.log('Music not loaded'));
            
            gameLoop();
        }

        function endGame() {
            gameState = 'ended';
            music.pause();
            setMobileControlsVisible(false); // Hide controls

            if (score > highScore) {
                highScore = score;
                localStorage.setItem('highScore', highScore);
            }
            
            document.getElementById('finalScore').textContent = Math.floor(score);
            document.getElementById('finalTime').textContent = gameTime.toFixed(2);
            document.getElementById('finalDistance').textContent = Math.floor(distance);
            document.getElementById('finalCoins').textContent = coins;
            document.getElementById('finalHighScore').textContent = Math.floor(highScore);
            document.getElementById('highScore').textContent = Math.floor(highScore);
            
            document.getElementById('gameOverScreen').classList.remove('hidden');
            addSaveButton();
            
            saveToLeaderboard(Math.floor(score));
        }

        function restartGame() {
            startGame();
        }

        function backToMenu() {
            gameState = 'menu';
            music.pause();
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
        }

        function showShop() {
            const wasPlaying = gameState === 'playing';
            if (wasPlaying) {
                music.pause();
            }
            
            gameState = 'shop';
            document.getElementById('shopScreen').classList.remove('hidden');
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            
            updateShopUI();
        }

        function closeShop() {
            document.getElementById('shopScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
            gameState = 'menu';
        }

        function updateShopUI() {
            document.getElementById('shopCoins').textContent = coins;
            document.getElementById('speedLevel').textContent = upgrades.speed;
            document.getElementById('boostLevel').textContent = upgrades.boost;
            document.getElementById('coinLevel').textContent = upgrades.coin;
        }

        function buyUpgrade(type) {
            const costs = {
                speed: 100,
                boost: 150,
                coin: 200
            };

            if (coins >= costs[type]) {
                coins -= costs[type];
                upgrades[type]++;
                localStorage.setItem(type + 'Level', upgrades[type]);
                updateShopUI();
                sounds.basePay();
            } else {
                alert('Not enough Sub-Cents! üí∞');
            }
        }
        
        function showFAQ() {
            document.getElementById('faqScreen').classList.remove('hidden');
            document.getElementById('startScreen').classList.add('hidden');
        }
        
        function closeFAQ() {
            document.getElementById('faqScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
        }
        
        function saveToLeaderboard(score) {
            let leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];
            
            leaderboard.push({
                name: "You",
                score: score
            });
            
            leaderboard.sort((a, b) => b.score - a.score);
            leaderboard = leaderboard.slice(0, 10);
            
            localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
        }
        
        function showLeaderboard() {
            document.getElementById('leaderboardScreen').classList.remove('hidden');
            document.getElementById('startScreen').classList.add('hidden');
            renderLeaderboard();
        }
        
        function closeLeaderboard() {
            document.getElementById('leaderboardScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
        }
        
        function renderLeaderboard() {
            const leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];
            const leaderboardList = document.getElementById('leaderboardList');
            
            leaderboardList.innerHTML = '';
            
            if (leaderboard.length === 0) {
                leaderboardList.innerHTML = '<div class="info-box"><p>Leaderboard is empty. Play to take first place!</p></div>';
                return;
            }
            
            leaderboard.forEach((entry, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                
                item.innerHTML = `
                    <div class="leaderboard-rank">#${index + 1}</div>
                    <div class="leaderboard-name">${entry.name}</div>
                    <div class="leaderboard-score">${entry.score}</div>
                `;
                
                leaderboardList.appendChild(item);
            });
        }
        
        // Init Logic
        initBackground();
        document.getElementById('highScore').textContent = Math.floor(highScore);
        
        // Initial control visibility check
        setMobileControlsVisible(false);
        
        // Initial resize
        resizeCanvas();
    </script>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
  // ‚öôÔ∏è –í–°–¢–ê–í–¨–¢–ï –í–ê–® –ê–î–†–ï–° –ù–ò–ñ–ï –í–ù–£–¢–†–ò –ö–ê–í–´–ß–ï–ö
  const CONTRACT_ADDRESS = "0xdb68CeBcF6D1f82b976fd21024aaE0ef30B8C18a"; // <-- –°–Æ–î–ê (–Ω–∞–ø—Ä–∏–º–µ—Ä: "0x4ed7...")

  // ABI (–æ–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞)
  const CONTRACT_ABI = [
      "function saveRecord(uint256 score, uint256 distance) external"
  ];

  async function sendTransactionToChain() {
    const btn = document.getElementById('saveOnChainBtn');

    if (!window.miniapp?.sdk?.wallet?.ethProvider) {
      alert("‚ùå Wallet not found. Open the game in Farcaster");
      return;
    }

    try {
      btn.disabled = true;
      btn.innerText = "‚è≥ Verification...";

      const provider = new ethers.providers.Web3Provider(window.miniapp.sdk.wallet.ethProvider);

      const chainIdHex = await provider.send("eth_chainId", []);
      if (chainIdHex !== "0x2105") {
         try {
             await provider.send("wallet_switchEthereumChain", [{ chainId: "0x2105" }]);
         } catch (switchError) {
             btn.disabled = false;
             btn.innerText = "üîó Save to Blockchain Base";
             alert(`‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å–µ—Ç—å (ID: ${chainIdHex}). –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∫–ª—é—á–∏ –∫–æ—à–µ–ª–µ–∫ –Ω–∞ Base Mainnet.`);
             return;
         }
      }

      const code = await provider.getCode(CONTRACT_ADDRESS);
      if (!code || code === "0x") {
        btn.disabled = false;
        btn.innerText = "üîó Save to Blockchain Base";
        alert(`‚ùå By address ${CONTRACT_ADDRESS} No contract. Check the deployment address and network.`);
        return;
      }

      btn.innerText = "‚è≥ Let's sign...";
      await provider.send("eth_requestAccounts", []);
      const signer = provider.getSigner();
      const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

      const cleanDistance = Math.floor(distance);

      await contract.estimateGas.saveRecord(score, cleanDistance);

      const tx = await contract.saveRecord(score, cleanDistance);
      btn.innerText = "‚è≥ Sending...";

      await tx.wait(1);
      btn.innerText = "‚úÖ Saved!";
      btn.style.background = "#00FF00";
      alert(`‚úÖ –£—Å–ø–µ—Ö! Tx: ${tx.hash}`);

    } catch (error) {
      console.error("Tx error:", error);
      btn.innerText = "üîó Save to Blockchain Base"; 
      btn.disabled = false;

      let errorMessage = error?.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";
      if (error?.data?.message) errorMessage = error.data.message;

      if (error?.code === 4001) {
        alert("‚ùå You have cancelled the transaction signing");
      } else {
        alert(`‚ùå Error: ${errorMessage}`);
      }
    }
  }

  function addSaveButton() {
      const container = document.querySelector('#gameOverScreen .button-group');
      if (!container) return;
      if (document.getElementById('saveOnChainBtn')) return;

      const btn = document.createElement('button');
      btn.id = "saveOnChainBtn";
      btn.innerText = "üîó Save to Blockchain Base";
      btn.onclick = sendTransactionToChain;
      btn.style.background = "#0052FF";
      btn.style.color = "white";
      btn.style.marginTop = "10px";

      container.insertBefore(btn, container.lastElementChild);
  }
</script>

</body>
</html>
